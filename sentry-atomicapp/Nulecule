---
specversion: 0.0.2
id: sentry-atomicapp

metadata:
  name: sentry Atomic App
  appversion: 1.0.0
  description: This is sentry

graph:
  - name: postgresql
    params:
      - name: db_user
        description: Database user
        default: sentry

      - name: db_pass
        description: Database password
        default: password

      - name: db_name
        description: Database name
        default: sentry

      - name: postgres_container_name
        desciption: Container name for postgresql
        default: postgres

      - name: postgres_container_image
        decription: Container image name for postgresql
        default: postgres
    params:
      name: $postgres_container_name
      image: $postgres_container_image
      db_name: $db_name
      db_user: $db_user
      db_pass: $db_pass
      service: postgres
    source: docker://pa/pg

  - name: redis
    params:
      - name: image_name
        default: redis

    mapping:
        # Dict similar to config data needed by the external application
        redismaster-app:
            image: $image_name
            service: $redis_service_name

        # By default mapping extends current config data
        # extend false will help in providing only those data
        # the external app and it's children needs
        # Default value is true.
        _inherit: false

    source: docker://pa/redis

  - name: sentry
    params:
      - name: sentry_container_name
        default: sentry
      - name: sentry_image_name
        default: rtnpro/sentry
      - name: sentry_node_port
        default: 30001

      # Reference a param from a sibling component
      - name: db_user
        link: $postgresql.db_user

      # Reference a param from a sibling component.
      - name: db_pass
        link: $postgresql.db_pass

    # Hypothetical, but allow mapping config values for local apps
    # if needed
    mapping:
        sentry:
          name: $sentry_container_name
          image: $sentry_image_name
          nodePort: $sentry_node_port

    artifacts:
      docker:
        - file://artifacts/docker/sentry
      kubernetes:
        - file://artifacts/kubernetes/sentry-pod.yaml
        - file://artifacts/kubernetes/sentry-service.yaml
